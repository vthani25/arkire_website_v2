---
import fs from 'fs';
import path from 'path';
import { marked } from 'marked';

export async function getStaticPaths() {
  const files = fs.readdirSync('./src/pages/blog');
  const paths = files
    .filter((file) => file.endsWith('.md'))
    .map((file) => ({
      params: { slug: file.replace('.md', '') }
    }));

  return { paths };
}

const { slug } = Astro.params;
const filePath = path.resolve(`./src/pages/blog/${slug}.md`);

let content = '';
try {
  content = fs.readFileSync(filePath, 'utf-8');
} catch {
  throw new Error('Post not found');
}

const frontmatterRegex = /^---\n([\s\S]+?)\n---/;
const match = content.match(frontmatterRegex);

let frontmatter = {};
let markdown = content;

if (match) {
  const fmText = match[1];
  markdown = content.slice(match[0].length);
  frontmatter = Object.fromEntries(
    fmText.split('\n').map((line) => {
      const [key, ...rest] = line.split(':');
      return [key.trim(), rest.join(':').trim()];
    })
  );
}

const html = marked.parse(markdown);
---

<html lang="en">
  <head>
    <title>{frontmatter.title || 'Post'}</title>
  </head>
  <body>
    <h1>{frontmatter.title}</h1>
    <p>{frontmatter.date}</p>
    <div set:html={html}></div>
  </body>
</html>
